kube-prometheus-stack:
  defaultRules:
    rules:
      kubeProxy: false
  grafana:
    enabled: {{ grafana_enabled }}
    persistence:
      type: pvc
      enabled: {{ we_have_storage }}
      storageClassName: ceph-block
      accessModes:
        - ReadWriteOnce
      size: 10Gi
    adminUser: {{ admin_user }}
    adminPassword: {{ admin_pass }}
    rbac:
      pspEnabled: true
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-gcp
        external-dns.alpha.kubernetes.io/hostname: {{ grafana_fqdn }}
        nginx.ingress.kubernetes.io/auth-url: https://{{ oauth_fqdn }}/oauth2/auth
        nginx.ingress.kubernetes.io/auth-signin: https://{{ oauth_fqdn }}/oauth2/start
        nginx.ingress.kubernetes.io/auth-response-headers: "x-auth-request-user, x-auth-request-email, x-auth-request-access-token"
      hosts:
        - {{ grafana_fqdn }}
      tls:
        - secretName: tls.{{ grafana_fqdn }}
          hosts:
            - {{ grafana_fqdn }}
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
        {% for satellite in satellites %}
        - name: {{ satellite.name }}Prometheus
          type: prometheus
          url: http://observability-{{ satellite.name|truncate(4, True, '', 0) }}-kube-p-prometheus.observability:9090
        {% endfor %}
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
        - name: ceph
          orgId: 1
          folder: ceph
          type: file
          disableDeletion: true
          editable: false
          options:
            path: /var/lib/grafana/dashboards/ceph
        {% for satellite in satellites %}
        - name: ceph-{{ satellite.name }}
          orgId: 1
          folder: ceph-{{ satellite.name }}
          type: file
          disableDeletion: true
          editable: false
          options:
            path: /var/lib/grafana/dashboards/ceph_{{ satellite.name }}
        {% endfor %}
    dashboards:
      ceph:
        #rgw:
        #  url: https://raw.githubusercontent.com/ceph/cephmetrics/master/dashboards/mgr-prometheus/ceph-rgw-workload.json
          #json: |
          #  "dashboards/rgw.json"
        cluster:
          gnetId: 2842
          revision: 17
          datasource: Prometheus
        osd:
          gnetId: 5336
          revision: 9
          datasource: Prometheus
        pools:
          gnetId: 5342
          revision: 9
          datasource: Prometheus
      {% for satellite in satellites %}
      ceph-{{ satellite.name }}:
        rgw:
          url: https://raw.githubusercontent.com/ceph/cephmetrics/master/dashboards/mgr-prometheus/ceph-rgw-workload.json
        #  json: |
        #    "dashboards/rgw.json"
        #cluster-{{ satellite.name }}:
        #  gnetId: 2842
        #  revision: 17
        #  datasource: {{ satellite.name }}Prometheus
        #osd-{{ satellite.name }}:
        #  gnetId: 5336
        #  revision: 9
        #  datasource: {{ satellite.name }}Prometheus
        #pools-{{ satellite.name }}:
        #  gnetId: 5342
        #  revision: 9
        #  datasource: {{ satellite.name }}Prometheus
      {% endfor %}
  kubeProxy:
    enabled: false
  prometheus:
    enabled: true
    prometheusSpec:
      serviceMonitorSelectorNilUsesHelmValues: false
      {% if we_have_storage %}
      storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
      {% else %}
      storageSpec: {}
      {% endif %}
    service:
      annotations:
        {% if workload_cluster %}
        io.cilium/global-service: 'true'
        {% endif %}